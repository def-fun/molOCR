<!doctype html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <title>化学结构式识别</title>
    <link rel="shortcut icon" href="favicon.ico"/>
    <!--    <link rel="stylesheet" href="https://cdn.bootcss.com/sweetalert/1.1.3/sweetalert.min.css"/>-->
    <!--    <script type="text/javascript" src="https://cdn.bootcss.com/sweetalert/1.1.3/sweetalert.min.js"></script>-->
    <!--    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.js"></script>-->
    <link rel="stylesheet" href="css/sweetalert.css"/>
    <script type="text/javascript" src="js/vendor/sweetalert.min.js"></script>
    <script type="text/javascript" src="js/vendor/jquery-1.10.2.min.js"></script>
    <link rel="stylesheet" href="css/ChemDoodleWeb.css" type="text/css">
    <script type="text/javascript" src="js/ChemDoodleWeb.js"></script>
    <link rel="stylesheet" href="js/uis/jquery-ui-1.11.4.css" type="text/css">
    <script type="text/javascript" src="js/uis/ChemDoodleWeb-uis.js"></script>
</head>
<style type="text/css">
    body > div {
        width: 80%;
        padding: .5em;
        margin: 0.5em auto;
    }

    .demo, .result {
        border: solid 1px #999;
        padding: 0.5em;
        margin: 1em 0 0 0;
        width: 100%;
    }

    .demo {
        width: 620px;
        height: 320px;
        overflow: auto;
    }

    .result > img {
        border: solid 1px #ccc;
        height: 50px;
    }

    .pastable {
        transition: box-shadow ease .3s;
    }

    .pastable:hover {
        box-shadow: 0 0 3px black;
    }

    .pastable.pastable-focus {
        box-shadow: 0 0 10px black;
    }

    .box {
        color: #bbb;
        padding: 10px;
    }
</style>

<script type="text/javascript" src="js/paste.js"></script>
<script type="text/javascript" src="js/img2mol_mark.js"></script>
<script type="text/javascript">
    $(function () {
        $('.demo-noninputable').pastableNonInputable();

        $('.demo').on('pasteImage', function (ev, data) {
            querySmiles(data.blob);
            $('.box').html('<img src="' + data.dataURL + '" style="max-height:300px; max-width:600px" alt=""> ');
            $('#debug').text('粘贴了图片: 宽' + data.width + ', 高 ' + data.height + ', 大小 ' + data.blob.size);
        }).on('pasteImageError', function (ev, data) {
            alert('Oops: ' + data.message);
            if (data.url) {
                alert('But we got its url anyway:' + data.url)
            }
        }).on('pasteText', function (ev, data) {
            // $('<div class="result"></div>').text('text: "' + data.text + '"').insertAfter(this);
            $('#debug').text('粘贴了文本: ' + data.text);
        });

        var imgContainer = document.getElementById("imgContainer");
        imgContainer.ondragover = function (e) {
            e.preventDefault();
            this.style.borderColor = 'red';
        };
        imgContainer.ondrop = function (e) {
            e.preventDefault();
            this.style.borderColor = 'black';
            if (e.dataTransfer.files.length > 1) {
                swal('拖放文件过多', '目前每次只支持拖放一张图片', 'error');
                $('#debug').text('拖放文件过多');
            } else {
                var fileObj = e.dataTransfer.files[0];
                if (fileObj.type.indexOf('image') !== -1) {
                    $('#debug').text('拖放了图片: "' + fileObj.name + '"  大小: ' + fileObj.size);
                    querySmiles(fileObj);
                    var blob = window.URL.createObjectURL(fileObj);
                    $('.box').html('<img src="' + blob + '" />'); // " style="max-height:300px; max-width:600px"

                } else {
                    $('#debug').text('拖放了非图片文件: "' + fileObj.name + '"');
                    swal('拖放了非图片文件', '只支持拖放图片文件', 'error');
                }
            }
        };
    });
    // test
    let pyridineMolFile = 'Molecule Name\n  CHEMDOOD01011121543D 0   0.00000     0.00000     0\n[Insert Comment Here]\n  6  6  0  0  0  0  0  0  0  0  1 V2000\n    0.0000    1.0000    0.0000   N 0  0  0  0  0  0  0  0  0  0  0  0\n   -0.8660    0.5000    0.0000   C 0  0  0  0  0  0  0  0  0  0  0  0\n   -0.8660   -0.5000    0.0000   C 0  0  0  0  0  0  0  0  0  0  0  0\n    0.0000   -1.0000    0.0000   C 0  0  0  0  0  0  0  0  0  0  0  0\n    0.8660   -0.5000    0.0000   C 0  0  0  0  0  0  0  0  0  0  0  0\n    0.8660    0.5000    0.0000   C 0  0  0  0  0  0  0  0  0  0  0  0\n  1  2  2  0  0  0  0\n  2  3  1  0  0  0  0\n  3  4  2  0  0  0  0\n  4  5  1  0  0  0  0\n  5  6  2  0  0  0  0\n  6  1  1  0  0  0  0\nM  END';
    let mol = ChemDoodle.readMOL(pyridineMolFile);
    let formula = {};
    for (let i = 0; i < mol.atoms.length; i++) {
        if (formula.hasOwnProperty(mol.atoms[i]['label'])) {
            formula[mol.atoms[i]['label']] += 1;
        } else {
            formula[mol.atoms[i]['label']] = 1;
        }
    }
</script>
<script type="application/javascript">
    $(document).ready
    {
        // ACS Document 1996
        ChemDoodle.DEFAULT_STYLES.bondLength_2D = 14.4;
        ChemDoodle.DEFAULT_STYLES.bonds_width_2D = .6;
        ChemDoodle.DEFAULT_STYLES.bonds_saturationWidthAbs_2D = 2.6;
        ChemDoodle.DEFAULT_STYLES.bonds_hashSpacing_2D = 2.5;
        ChemDoodle.DEFAULT_STYLES.atoms_font_size_2D = 10;
        ChemDoodle.DEFAULT_STYLES.atoms_font_families_2D = ['Helvetica', 'Arial', 'sans-serif'];
        ChemDoodle.DEFAULT_STYLES.atoms_displayTerminalCarbonLabels_2D = true;
        ChemDoodle.DEFAULT_STYLES.atoms_useJMOLColors = true;

        // changes the default JMol color of hydrogen to black so it appears on white backgrounds
        ChemDoodle.ELEMENT['H'].jmolColor = 'black';
        // darkens the default JMol color of sulfur so it appears on white backgrounds
        ChemDoodle.ELEMENT['S'].jmolColor = '#B9A130';
        // initializes the SketcherCanvas
        let sketcher = new ChemDoodle.SketcherCanvas('sketcher', 500, 300, {useServices: false, oneMolecule: false});
        // sets terminal carbon labels to display
        sketcher.styles.atoms_displayTerminalCarbonLabels_2D = true;
        // sets atom labels to be colored by JMol colors, which are easy to recognize
        sketcher.styles.atoms_useJMOLColors = true;
        // enables overlap clear widths, so that some depth is introduced to overlapping bonds
        sketcher.styles.bonds_clearOverlaps_2D = true;
        // sets the shape color to improve contrast when drawing figures
        sketcher.styles.shapes_color = 'c10000';
        // because we do not load any content, we need to repaint the sketcher, otherwise we would just see an empty area with the toolbar
        // however, you can instead use one of the Canvas.load... functions to pre-populate the canvas with content, then you don't need to call repaint
        sketcher.repaint();

        function redrawMolecular(molFile) {
            // let myCanvas = new ChemDoodle.ViewerCanvas('ChemDoodle', 150, 150);
            // let myCanvas = new ChemDoodle.SketcherCanvas('ChemDoodle', 500, 300, {'useServices': false});
            // let mol = ChemDoodle.readMOL(molFile);
            // myCanvas.loadMolecule(mol);

            let mol = ChemDoodle.readMOL(molFile);
            sketcher.loadMolecule(mol);
        }
    }
</script>
<body>

<div>
    <h1>化学结构式识别工具 V0.0.0.0.3</h1>
    <div class="demo demo-noninputable pastable" id="imgContainer">
        <div class="box">
            <h3>使用方法：</h3>
            <p>step.0 在电脑上使用Chrome/Firefox等现代浏览器访问此网页</p>
            <p>step.1 使用QQ/微信等截图软件, 截取文献中的结构式</p>
            <p>step.2 单击此处，在此处(Ctrl+V)粘贴截图</p>
            <p>step.3 单击文本框中的MOL文本(单击即可, 会自动复制)</p>
            <p>step.4 在KingDraw中右键 选择性粘贴 > MOL V2000(暂无快捷键)</p>
            <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 在ChemDraw中右键 paste special > MOL TEXT
                (Alt+Shift+Ctrl+P)</p>
        </div>
    </div>
    <canvas id="sketcher"></canvas>
    <div style="background: #b3d4fc">
        <p><span id="debug"></span></p>
        <p><span id="smiles"></span></p>

    </div>
    <div id="introduce">
        <h4>Feature</h4>
        <ul type="circle">
            <li>识别率还行😂</li>
            <li>重绘结构与原始结构的排版基本保持一致</li>
            <li>支持图片文件拖放</li>
            <li>识别到结构式时有红框标记</li>
        </ul>
        <h4>Tips</h4>
        <ul type="circle">
            <li>截图快捷键: QQ(Ctrl+Alt+A), 微信(Alt+A)</li>
            <li>只截取一个结构式时，识别准确率最高</li>
            <li>识别失败时，尝试放大文献后再截图识别</li>
            <li>单击文本框即自动复制</li>
            <li>会自动复制第一个MOL到剪切板</li>
            <li>ChemDraw中Ctrl+Shift+K快速格式化结构式, 可多次使用</li>
        </ul>
        <h4>Todo</h4>
        <ul type="circle">
            <li>加个网页版的结构式编辑器</li>
        </ul>
    </div>
</div>

</body>

</html>
